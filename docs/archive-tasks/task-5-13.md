# Задача 5.13: Реализация логики завершения уровня

## Описание
Реализовать функциональность завершения уровня, включая проверку выполнения всех необходимых условий, вызов соответствующей мутации из хука `useProgress` и отображение уведомления о разблокировке следующего уровня.

## Ссылки на документацию
docs/bizlevel-project-context.md
docs/status.md

## Конкретные шаги для Cursor
1. Создать компонент `CompleteLevelButton.tsx` для кнопки завершения уровня
2. Реализовать функцию проверки возможности завершения уровня
3. Интегрировать мутацию `completeLevel` из хука `useProgress`
4. Добавить диалоговое окно с поздравлением и информацией о разблокировке следующего уровня

## Промт для Cursor
```
Помоги мне реализовать логику завершения уровня для проекта BizLevel.

Нам нужно создать компонент для кнопки "Завершить уровень" и реализовать связанную логику проверки условий завершения, вызова соответствующей мутации и отображения уведомления о разблокировке следующего уровня.

1. Создай файл `src/components/features/Level/CompleteLevelButton.tsx`:
   - Компонент должен принимать props:
     - `levelId: string` - ID текущего уровня
     - `level: Level` - данные о текущем уровне
     - `userProgress: UserProgress` - прогресс пользователя
     - `onCompleteLevel: (levelId: string, nextLevelId: string) => void` - функция для вызова мутации завершения уровня
     - `nextLevel: Level | null` - данные о следующем уровне (если есть)
   
   - Компонент должен:
     - Отображать кнопку "Завершить уровень"
     - Проверять, может ли пользователь завершить уровень на основе критериев завершения (completionCriteria из уровня) и прогресса пользователя
     - Отключать кнопку, если не выполнены условия завершения
     - При наведении на отключенную кнопку показывать подсказку с информацией о невыполненных условиях
     - При клике открывать диалоговое окно для подтверждения

2. Создай файл `src/components/features/Level/CompletionDialog.tsx`:
   - Компонент для диалогового окна завершения уровня
   - Должен содержать:
     - Поздравление с завершением уровня
     - Информацию о разблокировке следующего уровня (если он есть)
     - Кнопки "Перейти к следующему уровню" и "Вернуться на карту уровней"
     - Анимацию или другой визуальный элемент для празднования достижения

3. Обнови страницу `src/app/(routes)/level/[levelId]/page.tsx`:
   - Интегрируй компонент CompleteLevelButton
   - Добавь функцию handleCompleteLevel для вызова мутации completeLevel из хука useProgress
   - Используй хук useNextLevel для получения данных о следующем уровне
   - Реализуй навигацию к следующему уровню или на карту уровней после завершения

4. Обнови хук `useProgress` в `src/hooks/useProgress.ts`:
   - Добавь или обнови функцию canCompleteLevelCheck, которая будет проверять, выполнены ли все условия для завершения уровня:
     - Просмотрены ли все необходимые видео (или минимальное количество, указанное в completionCriteria)
     - Пройдены ли все необходимые тесты (или минимальное количество, указанное в completionCriteria)
     - Другие возможные условия
   - Функция должна возвращать объект { canComplete: boolean, reason?: string } с флагом возможности завершения и причиной, если завершение невозможно

Все компоненты должны использовать shadcn/ui и Tailwind CSS для стилизации. После успешного завершения уровня должно отображаться toast-уведомление и/или диалоговое окно с поздравлением и информацией о разблокировке следующего уровня.

Пожалуйста, создай указанные компоненты и обнови страницу деталей уровня.

После выполнения задачи обнови status.md, указав, что задача 5.13 выполнена.
```

## Ожидаемый результат
- Созданные файлы:
  - `src/components/features/Level/CompleteLevelButton.tsx`
  - `src/components/features/Level/CompletionDialog.tsx`
- Обновленная страница деталей уровня с интегрированной кнопкой "Завершить уровень"
- Реализованная функция проверки возможности завершения уровня
- Интеграция мутации `completeLevel` из хука `useProgress`
- Добавленное диалоговое окно с поздравлением и информацией о разблокировке
- Обновленный файл status.md с отметкой о выполнении задачи 5.13

## Связь с другими задачами
- Эта задача следует за задачей 5.12: Реализация действий на странице уровня
- После выполнения этой задачи следует перейти к задаче 5.14: Заполнение Firestore данными для тестовых уровней

## Обновление progress-tracking
После выполнения задачи обновите файл development-plan.md, заменив `[ ]` на `[x]` для этой задачи:
```
* [x] **task-5.13-implement-level-completion.md**: Реализация логики завершения уровня (кнопка "Завершить", вызов `completeLevel` из `useProgress`)
```
