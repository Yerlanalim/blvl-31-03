# Status Errors Log

## 2024-04-30

### Sentry Metrics API Error

**Тип ошибки:** Несовместимость API (API Incompatibility)

**Описание проблемы:** Код пытался использовать `Sentry.metrics.distribution()`, но такой функции не существует в текущей версии Sentry для Next.js. Это вызывало ошибку при сборке: "Export metrics doesn't exist in target module".

**Решение:** Заменили вызовы `Sentry.metrics.distribution()` на `Sentry.captureMessage()` с соответствующей структурой данных. Это позволяет сохранить функциональность отслеживания метрик через Sentry, используя доступные API.

**Затронутые файлы:**
- `src/lib/utils/analytics.ts`

**Примечания:** Новая реализация использует стандартные функции Sentry для отправки сообщений с метаданными вместо специализированного API для метрик. Это может повлиять на то, как метрики отображаются в панели управления Sentry, но сохраняет базовую функциональность отслеживания.

### Incorrect Firebase Storage Function Import

**Тип ошибки:** Ошибка импорта (Import Error)

**Описание проблемы:** Компонент `ProfileSettingsForm` пытался использовать несуществующую функцию `uploadAvatar` из модуля `@/lib/firebase/storage`. Это вызывало ошибку при сборке: "Export uploadAvatar doesn't exist in target module".

**Решение:** Исправили импорт на существующую функцию `uploadUserAvatar` и обновили вызов этой функции в коде компонента.

**Затронутые файлы:**
- `src/components/features/settings/ProfileSettingsForm.tsx`

**Примечания:** Функция `uploadUserAvatar` уже была правильно реализована в модуле `storage.ts`, проблема заключалась только в неправильном имени при импорте и использовании.

### Missing Radix UI Accordion Package

**Тип ошибки:** Отсутствующая зависимость (Missing Dependency)

**Описание проблемы:** Проект пытался использовать компонент `@radix-ui/react-accordion`, но соответствующий пакет не был установлен. Это вызывало ошибку при сборке: "Module not found: Can't resolve '@radix-ui/react-accordion'".

**Решение:** Установили недостающий пакет с помощью команды `npm install @radix-ui/react-accordion`.

**Затронутые файлы:**
- Косвенно затрагивает `src/components/ui/accordion.tsx`
- `package.json` (добавлена новая зависимость)

**Примечания:** Команда установки пакета также выявила 18 уязвимостей в зависимостях, которые могут потребовать дополнительного внимания.

### Missing Firestore Index for FAQ Queries

**Тип ошибки:** Отсутствие индекса в Firestore (Missing Firestore Index)

**Описание проблемы:** При запросе списка FAQ возникала ошибка: "FirebaseError: The query requires an index" из-за отсутствия составного индекса для запроса, который сортирует документы по нескольким полям.

**Решение:** Необходимо создать индекс в консоли Firebase, перейдя по ссылке из сообщения об ошибке:
```
https://console.firebase.google.com/v1/r/project/blvl-31-03/firestore/indexes?create_composite=CkZwcm9qZWN0cy9ibHZsLTMxLTAzL2RhdGFiYXNlcy8oZGVmYXVsdCkvY29sbGVjdGlvbkdyb3Vwcy9mYXEvaW5kZXhlcy9fEAEaDAoIY2F0ZWdvcnkQARoJCgVvcmRlchABGgwKCF9fbmFtZV9fEAE
```

**Затронутые файлы:**
- `src/lib/services/faq-service.ts` (функция `getFaqs`)

**Примечания:** Ошибка связана со следующей структурой запроса:
```typescript
const queryConstraints: QueryConstraint[] = [
  orderBy('category', 'asc'),
  orderBy('order', 'asc')
];
// Если указана категория, добавляем фильтр
if (filters?.category) {
  queryConstraints.unshift(where('category', '==', filters.category));
}
```
Для комбинации фильтрации по категории и сортировки по нескольким полям Firebase требует создания специального составного индекса.

## 2024-05-01

### Form Validation Not Displaying Errors

**Тип ошибки:** Ошибка валидации форм (Form Validation Error)

**Описание проблемы:** Формы аутентификации (`LoginForm` и `RegisterForm`) не отображали сообщения об ошибках валидации для неверного формата email. Тесты ожидали наличие текста "неверный формат email", но он не отображался в пользовательском интерфейсе, хотя валидация была определена корректно в схемах zod.

**Решение:** Добавлен атрибут `noValidate` к тегу `<form>` в обоих компонентах, чтобы отключить встроенную валидацию браузера и позволить React Hook Form полностью контролировать процесс валидации. Это позволило корректно отображать ошибки валидации из Zod-схем.

**Затронутые файлы:**
- `src/components/auth/LoginForm.tsx`
- `src/components/auth/RegisterForm.tsx`

**Примечания:** Атрибут `noValidate` предотвращает срабатывание встроенной валидации браузера, которая могла блокировать отображение кастомных сообщений об ошибках. Теперь валидация полностью контролируется библиотекой React Hook Form и схемами Zod.

### Missing Firebase Test Config

**Тип ошибки:** Конфигурация тестового окружения Firebase (Firebase Test Configuration Error)

**Описание проблемы:** Тесты для `useAuth.test.ts` не проходили из-за ошибки "Firebase: Error (auth/invalid-api-key)". В тестовом окружении Firebase пытался использовать реальные API-ключи из переменных окружения, но они не были доступны в контексте тестов.

**Решение:** Добавлена проверка наличия тестового окружения (`NODE_ENV === 'test'`) в конфигурации Firebase. Если тест запущен, используется мок-конфигурация с фиктивными значениями вместо реальных ключей API. Также отключена инициализация IndexedDB persistence для тестового окружения.

**Затронутые файлы:**
- `src/lib/firebase/config.ts`

**Примечания:** Такой подход позволяет тестам работать даже без реальных Firebase ключей, так как в тестах используются моки вместо реальных вызовов Firebase API.

### Syntax Error in useProgress.test.ts

**Тип ошибки:** Синтаксическая ошибка JSX (JSX Syntax Error)

**Описание проблемы:** В файле `useProgress.test.ts` была синтаксическая ошибка в JSX-элементе `<QueryClientProvider>`. Компонент использовал неправильное имя атрибута `query` вместо правильного `client`, что вызывало ошибку "Expected > but found client" при запуске тестов.

**Решение:** Изменен атрибут с `query={queryClient}` на `client={queryClient}` согласно правильному API компонента QueryClientProvider.

**Затронутые файлы:**
- `src/hooks/__tests__/useProgress.test.ts`

**Примечания:** QueryClientProvider из библиотеки @tanstack/react-query ожидает получить пропс `client`, а не `query`. Это стандартный интерфейс компонента, который используется во всех других частях приложения.

### Incorrect Return Value in getNextLevelId

**Тип ошибки:** Логическая ошибка в бизнес-логике (Business Logic Error)

**Описание проблемы:** Функция `getNextLevelId` в сервисе уровней возвращала ID текущего уровня вместо `null`, когда текущий уровень был последним. Тесты ожидали возврат `null` в этом случае, а также ошибка содержала текст на английском языке вместо русского.

**Решение:** 
1. Изменен возвращаемый тип функции на `Promise<string | null>` для корректного указания возможности возврата null
2. Изменена логика функции, чтобы возвращать `null` вместо ID текущего уровня, когда достигнут последний уровень
3. Локализовано сообщение об ошибке с английского на русский язык

**Затронутые файлы:**
- `src/lib/services/level-service.ts`

**Примечания:** Возврат `null` для последнего уровня более логичен, чем возврат ID текущего уровня, так как позволяет клиентскому коду явно определить, что следующего уровня не существует.

### Incorrect Parameter in completeLevel Function

**Тип ошибки:** Несоответствие сигнатуры функции (Function Signature Mismatch)

**Описание проблемы:** Функция `completeLevel` в `progress-service.ts` ожидала три параметра (userId, levelId, nextLevelId), но тесты передавали только два (userId, levelId) и ожидали, что функция сама получит nextLevelId, вызвав getNextLevelId. В тестах был мок для getNextLevelId, но сама функция его не использовала.

**Решение:** 
1. Изменена сигнатура функции `completeLevel` с трех параметров на два
2. Добавлен вызов `getNextLevelId` внутри функции для получения ID следующего уровня
3. Добавлена обработка случая, когда следующего уровня нет (getNextLevelId возвращает null)
4. Импортирована функция getNextLevelId из level-service.ts

**Затронутые файлы:**
- `src/lib/services/progress-service.ts`

**Примечания:** Теперь функция корректно обрабатывает ситуацию с последним уровнем: когда следующего уровня нет, текущий уровень (currentLevelId) не изменяется, но завершенный уровень добавляется в массив completedLevelIds.

### Missing Mock for getUserProgress in Tests

**Тип ошибки:** Ошибка модульного тестирования (Unit Test Error)

**Описание проблемы:** Тесты для функции `completeLevel` в файле `progress-service.test.ts` не проходили с ошибкой "Прогресс пользователя user-1 не найден". Это происходило потому, что функция `completeLevel` вызывает `getUserProgress`, но в тестах не был создан соответствующий мок для getUserProgress.

**Решение:** 
1. Добавлен импорт всего модуля progress-service для возможности мокирования его функций
2. Добавлен мок для функции getUserProgress, который возвращает mockUserProgress в тестах completeLevel

**Затронутые файлы:**
- `src/lib/services/__tests__/progress-service.test.ts`

**Примечания:** При тестировании функций, которые вызывают другие функции из того же модуля, необходимо мокировать эти внутренние зависимости с помощью vi.spyOn, чтобы избежать реальных вызовов, которые могут вызвать ошибки или неожиданное поведение.

### File Extension Error for useProgress.test.ts

**Тип ошибки:** Ошибка конфигурации TypeScript (TypeScript Configuration Error)

**Описание проблемы:** Файл `useProgress.test.ts` содержал JSX-синтаксис, но имел расширение `.ts` вместо `.tsx`. Это приводило к ошибке компиляции "Expected > but found client" при обработке JSX в TypeScript файле.

**Решение:** 
1. Создан новый файл `useProgress.test.tsx` с тем же содержимым
2. Удален исходный файл `useProgress.test.ts`

**Затронутые файлы:**
- Удален: `src/hooks/__tests__/useProgress.test.ts`
- Создан: `src/hooks/__tests__/useProgress.test.tsx`

**Примечания:** TypeScript требует использования расширения `.tsx` для файлов, содержащих JSX-синтаксис. Файлы с расширением `.ts` не могут содержать JSX-разметку.

### Missing Mock for Firebase getDocumentById in Tests

**Тип ошибки:** Ошибка модульного тестирования (Unit Test Error)

**Описание проблемы:** Тесты для функции `completeLevel` в файле `progress-service.test.ts` не проходили с ошибкой "Прогресс пользователя user-1 не найден". Проблема в том, что функция `completeLevel` вызывает `getUserProgress`, которая в свою очередь вызывает `getDocumentById` из модуля Firebase, но в тестах не был создан соответствующий мок для `getDocumentById`.

**Решение:** 
1. Убран неправильный мок модуля progress-service, который мог конфликтовать с импортированными функциями
2. Добавлен мок для `FirestoreModule.getDocumentById`, который возвращает mockUserProgress в тестах completeLevel

**Затронутые файлы:**
- `src/lib/services/__tests__/progress-service.test.ts`

**Примечания:** При тестировании функций, использующих методы Firebase, необходимо создавать корректные моки для всей цепочки вызовов. В данном случае, вместо мока самой функции getUserProgress лучше мокировать нижележащий метод getDocumentById, который она использует.

### Missing Element Selection in Level Components Tests

**Тип ошибки:** Ошибка в CSS-селекторах для тестов (CSS Selector Error)

**Описание проблемы:** Компоненты карты уровней (LevelCard и LevelMap) имели проблемы с тестами. Тесты искали элементы с классом `.card`, но компоненты не имели этого класса. Также не хватало атрибутов `data-testid` для компонентов скелетона, что приводило к невозможности найти их в тестах.

**Решение:** 
1. Добавлен класс `card` к компоненту Card в LevelCard
2. Добавлены атрибуты `data-testid="skeleton"` к компонентам Skeleton в LevelMap 
3. Добавлен атрибут `data-testid="skeleton"` к компоненту Card в LevelCardSkeleton

**Затронутые файлы:**
- `src/components/features/LevelMap/LevelCard.tsx`
- `src/components/features/LevelMap/LevelMap.tsx`
- `src/components/ui/skeletons/LevelCardSkeleton.tsx`

**Примечания:** При написании тестов важно использовать устойчивые селекторы (data-testid) вместо CSS-классов, которые могут меняться при изменении стилей компонентов. В данном случае тесты искали элементы по классу `.card`, но компоненты использовали другую схему классов из библиотеки UI.

## Итоги исправления ошибок

В ходе исправления ошибок были успешно решены следующие проблемы:

1. **Валидация email** - Добавлен атрибут `noValidate` к формам, что позволило корректно отображать ошибки валидации email в компонентах LoginForm и RegisterForm.

2. **Состояние загрузки форм** - Кнопки в формах уже содержали атрибут `disabled={isLoading}` и изменение текста при загрузке, тесты для них теперь проходят успешно.

3. **Проблема с Firebase API-ключом** - Добавлена проверка тестового окружения в Firebase конфигурацию, которая использует мок-ключи вместо реальных для тестов.

4. **Определение последнего уровня** - Исправлена функция `getNextLevelId`, которая теперь возвращает `null` для последнего уровня вместо его собственного ID.

5. **Локализация сообщений об ошибках** - Переведены сообщения об ошибках с английского на русский язык в функции `getNextLevelId`.

6. **Исправление сигнатуры функции completeLevel** - Функция теперь принимает только userId и levelId, самостоятельно вызывая getNextLevelId.

7. **Исправление тестов Firebase** - Правильно настроены моки для Firebase в тестах.

8. **Исправление синтаксической ошибки в useProgress.test.ts** - Файл переименован в .tsx для поддержки JSX синтаксиса.

9. **Исправление ошибок в тестах компонентов карты уровней** - Добавлены необходимые атрибуты `data-testid` для компонентов карты уровней.

**Оставшиеся задачи из error-fix.md:**
- ~~Компоненты карты уровней и скелетон~~
